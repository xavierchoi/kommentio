<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Login ìµœì¢… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f7;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .step {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #007aff;
        }
        .test-btn {
            background: #007aff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-btn-success {
            background: #28a745;
        }
        .test-btn-warning {
            background: #ffc107;
            color: #000;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        .mode-indicator {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .mode-mock {
            background: #fef3c7;
            color: #92400e;
        }
        .mode-production {
            background: #d1fae5;
            color: #065f46;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ Apple Login ìµœì¢… í…ŒìŠ¤íŠ¸</h1>
        <p>Supabase ì—°ê²° ë¬¸ì œë¥¼ ê·¼ë³¸ì ìœ¼ë¡œ í•´ê²°í•˜ì—¬ ì‹¤ì œ Production ëª¨ë“œ í…ŒìŠ¤íŠ¸</p>
        
        <div class="mode-indicator mode-mock" id="mode-indicator">
            ğŸ”„ ëª¨ë“œ í™•ì¸ ì¤‘...
        </div>
        
        <div class="step">
            <h3>1ë‹¨ê³„: ì§ì ‘ Production ìœ„ì ¯ ìƒì„±</h3>
            <p>UUID ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ì˜¬ë°”ë¥¸ Production ìœ„ì ¯ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
            <button class="test-btn test-btn-warning" onclick="createProductionWidget()">Production ìœ„ì ¯ ìƒì„±</button>
        </div>
        
        <div class="step">
            <h3>2ë‹¨ê³„: Apple OAuth í…ŒìŠ¤íŠ¸</h3>
            <p>Production ëª¨ë“œì—ì„œ ì‹¤ì œ Apple OAuthë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <button class="test-btn test-btn-success" onclick="testAppleOAuth()" id="appleTestBtn" disabled>ğŸ Apple OAuth í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div class="step">
            <h3>3ë‹¨ê³„: ì „ì²´ í”„ë¡œë°”ì´ë” í…ŒìŠ¤íŠ¸</h3>
            <p>ëª¨ë“  ì†Œì…œ ë¡œê·¸ì¸ í”„ë¡œë°”ì´ë”ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <button class="test-btn" onclick="testAllProviders()" id="allTestBtn" disabled>ğŸŒ ì „ì²´ í”„ë¡œë°”ì´ë” í…ŒìŠ¤íŠ¸</button>
        </div>
        
        <div class="log" id="log">Apple Login ìµœì¢… í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”...\n</div>
        
        <div id="widget-container">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ìœ„ì ¯ -->
        </div>
    </div>

    <script src="kommentio.js"></script>
    
    <script>
        let productionSiteUUID = null;
        
        function log(message) {
            const logEl = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `[${time}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[${time}] ${message}`);
        }
        
        function updateModeIndicator() {
            const indicator = document.getElementById('mode-indicator');
            if (window.kommentio) {
                if (window.kommentio.mockMode) {
                    indicator.textContent = 'ğŸ­ Mock ëª¨ë“œ (ê°€ìƒ ë°ì´í„°)';
                    indicator.className = 'mode-indicator mode-mock';
                } else {
                    indicator.textContent = 'ğŸ” Production ëª¨ë“œ (ì‹¤ì œ Supabase)';
                    indicator.className = 'mode-indicator mode-production';
                }
            } else {
                indicator.textContent = 'â³ ìœ„ì ¯ ë¡œë”© ì¤‘...';
                indicator.className = 'mode-indicator mode-mock';
            }
        }
        
        async function createProductionWidget() {
            log('ğŸ”§ Production ìœ„ì ¯ ìƒì„± ì‹œì‘...');
            
            try {
                // 1. Supabase SDK ë¡œë”© í™•ì¸
                if (!window.supabase) {
                    log('ğŸ“¦ Supabase SDK ë¡œë”© ì¤‘...');
                    await loadSupabaseSDK();
                    log('âœ… Supabase SDK ë¡œë“œ ì™„ë£Œ');
                }
                
                // 2. Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„±
                const supabase = window.supabase.createClient(
                    'https://nwjbtsjeikrwyqltkpqv.supabase.co',
                    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53amJ0c2plaWtyd3lxbHRrcHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NDA0MDUsImV4cCI6MjA2NTExNjQwNX0.UXNFgCrKfBHrcbenw94v9rD-sbGEE6ENDaF7h01EFPQ'
                );
                log('âœ… Supabase í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì™„ë£Œ');
                
                // 3. ì—°ê²° í…ŒìŠ¤íŠ¸
                log('ğŸ” Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...');
                const { data: testData, error: testError } = await supabase
                    .from('sites')
                    .select('count', { count: 'exact' })
                    .limit(1);
                
                if (testError) {
                    log(`âŒ Supabase ì—°ê²° ì‹¤íŒ¨: ${testError.message}`);
                    log('ğŸ’¡ Mock ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ì—¬ Apple Login í…ŒìŠ¤íŠ¸ë¥¼ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.');
                    createMockWidget();
                    return;
                }
                
                log(`âœ… Supabase ì—°ê²° ì„±ê³µ (sites í…Œì´ë¸” í™•ì¸)`);
                
                // 4. UUID ë°©ì‹ìœ¼ë¡œ ì‚¬ì´íŠ¸ ìƒì„±/í™•ì¸
                productionSiteUUID = await createOrFindSiteUUID(supabase);
                log(`âœ… ì‚¬ì´íŠ¸ UUID ì¤€ë¹„: ${productionSiteUUID}`);
                
                // 5. Production ìœ„ì ¯ ìƒì„±
                log('ğŸ”„ Production ìœ„ì ¯ ìƒì„± ì¤‘...');
                const container = document.getElementById('widget-container');
                
                // ê¸°ì¡´ ìœ„ì ¯ ì œê±°
                container.innerHTML = '';
                if (window.kommentio) {
                    window.kommentio = null;
                }
                
                // ìƒˆ ìœ„ì ¯ HTML ìƒì„±
                container.innerHTML = `
                    <div 
                        data-kommentio
                        data-site-id="${productionSiteUUID}"
                        data-page-url="/apple-oauth-test"
                        data-theme="light"
                        data-language="ko"
                        data-supabase-url="https://nwjbtsjeikrwyqltkpqv.supabase.co"
                        data-supabase-key="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im53amJ0c2plaWtyd3lxbHRrcHF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NDA0MDUsImV4cCI6MjA2NTExNjQwNX0.UXNFgCrKfBHrcbenw94v9rD-sbGEE6ENDaF7h01EFPQ"
                    ></div>
                `;
                
                // ìœ„ì ¯ ì´ˆê¸°í™” ëŒ€ê¸°
                setTimeout(() => {
                    if (window.kommentio) {
                        updateModeIndicator();
                        if (!window.kommentio.mockMode) {
                            log('ğŸ‰ Production ëª¨ë“œ ìœ„ì ¯ ìƒì„± ì„±ê³µ!');
                            log('ğŸ ì´ì œ Apple OAuth í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                            document.getElementById('appleTestBtn').disabled = false;
                            document.getElementById('allTestBtn').disabled = false;
                        } else {
                            log('âš ï¸ ì—¬ì „íˆ Mock ëª¨ë“œì…ë‹ˆë‹¤. Supabase ì„¤ì •ì„ ë‹¤ì‹œ í™•ì¸í•´ë³´ì„¸ìš”.');
                            log('ğŸ­ Mock ëª¨ë“œì—ì„œë„ Apple Login ê¸°ëŠ¥ì€ ì™„ì „íˆ ì‘ë™í•©ë‹ˆë‹¤.');
                            document.getElementById('appleTestBtn').disabled = false;
                            document.getElementById('allTestBtn').disabled = false;
                        }
                    } else {
                        log('âŒ ìœ„ì ¯ ì´ˆê¸°í™” ì‹¤íŒ¨');
                    }
                }, 2000);
                
            } catch (error) {
                log(`âŒ Production ìœ„ì ¯ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
                log('ğŸ’¡ Mock ëª¨ë“œë¡œ ì „í™˜í•˜ì—¬ ê³„ì† í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.');
                createMockWidget();
            }
        }
        
        function createMockWidget() {
            log('ğŸ­ Mock ëª¨ë“œ ìœ„ì ¯ ìƒì„±...');
            const container = document.getElementById('widget-container');
            
            container.innerHTML = `
                <div 
                    data-kommentio
                    data-site-id="apple-mock-test"
                    data-page-url="/apple-mock-test"
                    data-theme="light"
                    data-language="ko"
                ></div>
            `;
            
            setTimeout(() => {
                updateModeIndicator();
                log('âœ… Mock ëª¨ë“œ ìœ„ì ¯ ìƒì„± ì™„ë£Œ');
                log('ğŸ Mock ëª¨ë“œì—ì„œ Apple Login í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                document.getElementById('appleTestBtn').disabled = false;
                document.getElementById('allTestBtn').disabled = false;
            }, 2000);
        }
        
        async function testAppleOAuth() {
            log('ğŸ Apple OAuth í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            try {
                if (!window.kommentio) {
                    log('âŒ Kommentio ìœ„ì ¯ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                log(`ğŸ“Š í˜„ì¬ ëª¨ë“œ: ${window.kommentio.mockMode ? 'Mock' : 'Production'}`);
                
                // Apple ë¡œê·¸ì¸ ì‹¤í–‰
                log('â³ Apple ë¡œê·¸ì¸ ì‹¤í–‰ ì¤‘...');
                await window.kommentio.login('apple');
                
                // ê²°ê³¼ í™•ì¸
                if (window.kommentio.currentUser) {
                    log('ğŸ‰ Apple ë¡œê·¸ì¸ ì„±ê³µ!');
                    log(`ğŸ‘¤ ì‚¬ìš©ì ID: ${window.kommentio.currentUser.id}`);
                    log(`ğŸ“§ ì´ë©”ì¼: ${window.kommentio.currentUser.email}`);
                    log(`ğŸ·ï¸ ì´ë¦„: ${window.kommentio.currentUser.user_metadata?.name}`);
                    log(`ğŸ”— í”„ë¡œë°”ì´ë”: ${window.kommentio.currentUser.user_metadata?.provider}`);
                    
                    if (window.kommentio.mockMode) {
                        log('ğŸ­ Mock ëª¨ë“œ: ê°€ìƒ Apple ì‚¬ìš©ìê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        log('ğŸ’¡ ì‹¤ì œ Apple OAuthëŠ” Production ëª¨ë“œì—ì„œ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”.');
                    } else {
                        log('ğŸ” Production ëª¨ë“œ: ì‹¤ì œ Apple OAuth ì²˜ë¦¬ ì™„ë£Œ.');
                    }
                    
                    // ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸
                    log('ğŸšª ë¡œê·¸ì•„ì›ƒ í…ŒìŠ¤íŠ¸...');
                    window.kommentio.logout();
                    log('âœ… ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
                    
                } else {
                    log('âš ï¸ ë¡œê·¸ì¸í–ˆì§€ë§Œ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                log(`âŒ Apple OAuth í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
                console.error('Apple OAuth error:', error);
            }
        }
        
        async function testAllProviders() {
            log('ğŸŒ ì „ì²´ ì†Œì…œ í”„ë¡œë°”ì´ë” í…ŒìŠ¤íŠ¸ ì‹œì‘...');
            
            const providers = [
                { name: 'google', display: 'ğŸ” Google' },
                { name: 'apple', display: 'ğŸ Apple' },
                { name: 'github', display: 'ğŸ™ GitHub' },
                { name: 'twitter', display: 'ğŸ¦ X (Twitter)' },
                { name: 'facebook', display: 'ğŸ“˜ Facebook' },
                { name: 'linkedin', display: 'ğŸ’¼ LinkedIn' },
                { name: 'kakao', display: 'ğŸ’› Kakao' }
            ];
            
            for (const provider of providers) {
                try {
                    log(`\nğŸ” ${provider.display} í…ŒìŠ¤íŠ¸...`);
                    await window.kommentio.login(provider.name);
                    
                    if (window.kommentio.currentUser) {
                        log(`âœ… ${provider.display} ë¡œê·¸ì¸ ì„±ê³µ`);
                        window.kommentio.logout();
                        log(`ğŸšª ${provider.display} ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ`);
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    log(`âŒ ${provider.display} ì‹¤íŒ¨: ${error.message}`);
                }
            }
            
            log('\nğŸ¯ ì „ì²´ í”„ë¡œë°”ì´ë” í…ŒìŠ¤íŠ¸ ì™„ë£Œ!');
        }
        
        // í—¬í¼ í•¨ìˆ˜ë“¤
        function loadSupabaseSDK() {
            return new Promise((resolve, reject) => {
                if (window.supabase) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        async function createOrFindSiteUUID(supabase) {
            try {
                // ê°„ë‹¨í•œ UUID ìƒì„± (ì‹¤ì œë¡œëŠ” Supabaseê°€ ìë™ ìƒì„±)
                const testSiteId = 'f47ac10b-58cc-4372-a567-0e02b2c3d479'; // ì˜ˆì‹œ UUID
                
                // ë¨¼ì € í…ŒìŠ¤íŠ¸ìš© ê³ ì • UUIDë¡œ ì‹œë„
                const { data: existingSite, error: selectError } = await supabase
                    .from('sites')
                    .select('id')
                    .eq('id', testSiteId)
                    .single();
                
                if (existingSite && !selectError) {
                    log(`âœ… ê¸°ì¡´ ì‚¬ì´íŠ¸ UUID ì‚¬ìš©: ${testSiteId}`);
                    return testSiteId;
                }
                
                // ìƒˆ ì‚¬ì´íŠ¸ ìƒì„±
                const { data: newSite, error: insertError } = await supabase
                    .from('sites')
                    .insert([{
                        name: 'apple-production-test',
                        domain: window.location.hostname,
                        description: 'Apple OAuth Production Test'
                    }])
                    .select('id')
                    .single();
                
                if (newSite && !insertError) {
                    log(`âœ… ìƒˆ ì‚¬ì´íŠ¸ UUID ìƒì„±: ${newSite.id}`);
                    return newSite.id;
                } else {
                    throw new Error(`Site creation failed: ${insertError?.message}`);
                }
                
            } catch (error) {
                log(`âš ï¸ ì‚¬ì´íŠ¸ UUID ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`);
                log(`ğŸ’¡ ê³ ì • UUID ì‚¬ìš©: f47ac10b-58cc-4372-a567-0e02b2c3d479`);
                return 'f47ac10b-58cc-4372-a567-0e02b2c3d479';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            log('ğŸ“„ Apple Login ìµœì¢… í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œë¨');
            log('1ï¸âƒ£ "Production ìœ„ì ¯ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”');
            
            setTimeout(() => {
                updateModeIndicator();
                if (window.kommentio) {
                    log('âœ… ê¸°ë³¸ Kommentio ìœ„ì ¯ ë¡œë“œë¨');
                    log(`ğŸ“Š í˜„ì¬ ëª¨ë“œ: ${window.kommentio.mockMode ? 'Mock' : 'Production'}`);
                }
            }, 1000);
        });
    </script>
</body>
</html>